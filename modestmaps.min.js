if(!com){var com={};if(!com.modestmaps){com.modestmaps={}}}com.modestmaps.extend=function(c,a){for(var b in a.prototype){if(typeof c.prototype[b]=="undefined"){c.prototype[b]=a.prototype[b]}}return c};com.modestmaps.cancelEvent=function(a){a.cancelBubble=true;a.cancel=true;a.returnValue=false;if(a.stopPropagation){a.stopPropagation()}if(a.preventDefault){a.preventDefault()}return false};com.modestmaps.addEvent=function(c,b,a){if(c.attachEvent){c["e"+b+a]=a;c[b+a]=function(){c["e"+b+a](window.event)};c.attachEvent("on"+b,c[b+a])}else{c.addEventListener(b,a,false);if(b=="mousewheel"){c.addEventListener("DOMMouseScroll",a,false)}}};com.modestmaps.removeEvent=function(c,b,a){if(c.detachEvent){c.detachEvent("on"+b,c[b+a]);c[b+a]=null}else{c.removeEventListener(b,a,false);if(b=="mousewheel"){c.removeEventListener("DOMMouseScroll",a,false)}}};com.modestmaps.Point=function(a,b){this.x=parseFloat(a);this.y=parseFloat(b)};com.modestmaps.Point.prototype={x:0,y:0,toString:function(){return"("+this.x.toFixed(3)+", "+this.y.toFixed(3)+")"}};com.modestmaps.Coordinate=function(c,a,b){this.row=c;this.column=a;this.zoom=b};com.modestmaps.Coordinate.prototype={row:0,column:0,zoom:0,toString:function(){return"("+this.row.toFixed(3)+", "+this.column.toFixed(3)+" @"+this.zoom.toFixed(3)+")"},toKey:function(){var e=parseInt(this.row);var d=parseInt(this.column);var f=parseInt(this.zoom);e=e-d;e=e-f;e=e^(f>>>13);d=d-f;d=d-e;d=d^(e<<8);f=f-e;f=f-d;f=f^(d>>>13);e=e-d;e=e-f;e=e^(f>>>12);d=d-f;d=d-e;d=d^(e<<16);f=f-e;f=f-d;f=f^(d>>>5);e=e-d;e=e-f;e=e^(f>>>3);d=d-f;d=d-e;d=d^(e<<10);f=f-e;f=f-d;f=f^(d>>>15);return f},copy:function(){return new com.modestmaps.Coordinate(this.row,this.column,this.zoom)},container:function(){return new com.modestmaps.Coordinate(Math.floor(this.row),Math.floor(this.column),Math.floor(this.zoom))},zoomTo:function(a){var b=Math.pow(2,a-this.zoom);return new com.modestmaps.Coordinate(this.row*b,this.column*b,a)},zoomBy:function(b){var a=Math.pow(2,b);return new com.modestmaps.Coordinate(this.row*a,this.column*a,this.zoom+b)},up:function(a){if(a==undefined){a=1}return new com.modestmaps.Coordinate(this.row-a,this.column,this.zoom)},right:function(a){if(a==undefined){a=1}return new com.modestmaps.Coordinate(this.row,this.column+a,this.zoom)},down:function(a){if(a==undefined){a=1}return new com.modestmaps.Coordinate(this.row+a,this.column,this.zoom)},left:function(a){if(a==undefined){a=1}return new com.modestmaps.Coordinate(this.row,this.column-a,this.zoom)}};com.modestmaps.Location=function(a,b){this.lat=parseFloat(a);this.lon=parseFloat(b)};com.modestmaps.Location.prototype={lat:0,lon:0,toString:function(){return"("+this.lat.toFixed(3)+", "+this.lon.toFixed(3)+")"}};com.modestmaps.Transformation=function(c,e,a,b,d,f){this.ax=c;this.bx=e;this.cx=a;this.ay=b;this.by=d;this.cy=f};com.modestmaps.Transformation.prototype={ax:0,bx:0,cx:0,ay:0,by:0,cy:0,transform:function(a){return new com.modestmaps.Point(this.ax*a.x+this.bx*a.y+this.cx,this.ay*a.x+this.by*a.y+this.cy)},untransform:function(a){return new com.modestmaps.Point((a.x*this.by-a.y*this.bx-this.cx*this.by+this.cy*this.bx)/(this.ax*this.by-this.ay*this.bx),(a.x*this.ay-a.y*this.ax-this.cx*this.ay+this.cy*this.ax)/(this.bx*this.ay-this.by*this.ax))},deriveTransformation:function(k,j,e,d,a,n,g,f,c,b,m,l){var i=this.linearSolution(k,j,e,a,n,g,c,b,m);var h=this.linearSolution(k,j,d,a,n,f,c,b,l);return new com.modestmaps.Transformation(i[0],i[1],i[2],h[0],h[1],h[2])},linearSolution:function(f,o,i,e,n,h,d,m,g){f=parseFloat(f);o=parseFloat(o);i=parseFloat(i);e=parseFloat(e);n=parseFloat(n);h=parseFloat(h);d=parseFloat(d);m=parseFloat(m);g=parseFloat(g);var l=(((h-g)*(o-n))-((i-h)*(n-m)))/(((e-d)*(o-n))-((f-e)*(n-m)));var k=(((h-g)*(f-e))-((i-h)*(e-d)))/(((n-m)*(f-e))-((o-n)*(e-d)));var j=i-(f*l)-(o*k);return[l,k,j]}};com.modestmaps.Projection=function(b,a){if(!a){a=com.modestmaps.Transformation(1,0,0,0,1,0)}this.zoom=b;this.transformation=a};com.modestmaps.Projection.prototype={zoom:0,transformation:null,rawProject:function(a){alert("Abstract method not implemented by subclass.")},rawUnproject:function(a){alert("Abstract method not implemented by subclass.")},project:function(a){a=this.rawProject(a);if(this.transformation){a=this.transformation.transform(a)}return a},unproject:function(a){if(this.transformation){a=this.transformation.untransform(a)}a=this.rawUnproject(a);return a},locationCoordinate:function(b){var a=new com.modestmaps.Point(Math.PI*b.lon/180,Math.PI*b.lat/180);a=this.project(a);return new com.modestmaps.Coordinate(a.y,a.x,this.zoom)},coordinateLocation:function(b){b=b.zoomTo(this.zoom);var a=new com.modestmaps.Point(b.column,b.row);a=this.unproject(a);return new com.modestmaps.Location(180*a.y/Math.PI,180*a.x/Math.PI)}};com.modestmaps.LinearProjection=function(b,a){com.modestmaps.Projection.call(this,b,a)};com.modestmaps.LinearProjection.prototype={rawProject:function(a){return new com.modestmaps.Point(a.x,a.y)},rawUnproject:function(a){return new com.modestmaps.Point(a.x,a.y)}};com.modestmaps.extend(com.modestmaps.LinearProjection,com.modestmaps.Projection);com.modestmaps.MercatorProjection=function(b,a){com.modestmaps.Projection.call(this,b,a)};com.modestmaps.MercatorProjection.prototype={rawProject:function(a){return new com.modestmaps.Point(a.x,Math.log(Math.tan(0.25*Math.PI+0.5*a.y)))},rawUnproject:function(a){return new com.modestmaps.Point(a.x,2*Math.atan(Math.pow(Math.E,a.y))-0.5*Math.PI)}};com.modestmaps.extend(com.modestmaps.MercatorProjection,com.modestmaps.Projection);com.modestmaps.MapProvider=function(a){if(a){this.getTileUrl=a}};com.modestmaps.MapProvider.prototype={projection:new com.modestmaps.MercatorProjection(26,new com.modestmaps.Transformation(10680707.79,0,33554431.85,0,-10680708.9,33554430.57)),tileWidth:256,tileHeight:256,getTileUrl:function(a){alert("Abstract method not implemented by subclass.")},locationCoordinate:function(a){return this.projection.locationCoordinate(a)},coordinateLocation:function(a){return this.projection.coordinateLocation(a)},sourceCoordinate:function(b){var a=b.column%Math.pow(2,b.zoom);while(a<0){a+=Math.pow(2,b.zoom)}return new com.modestmaps.Coordinate(b.row,a,b.zoom)}};com.modestmaps.TemplatedMapProvider=function(a){com.modestmaps.MapProvider.call(this,function(c){var b=a.replace("{Z}",c.zoom.toFixed(0));b=b.replace("{X}",c.column.toFixed(0));return b.replace("{Y}",c.row.toFixed(0))})};com.modestmaps.extend(com.modestmaps.TemplatedMapProvider,com.modestmaps.MapProvider);com.modestmaps.Map=function(b,e,c){if(typeof b=="string"){b=document.getElementById(b)}this.parent=b;this.idBase=b.id;this.parent.style.position="relative";this.parent.style.width=parseInt(c.x)+"px";this.parent.style.height=parseInt(c.y)+"px";this.parent.style.padding="0";this.parent.style.overflow="hidden";this.parent.style.backgroundColor="#eee";com.modestmaps.addEvent(this.parent,"dblclick",this.getDoubleClick());com.modestmaps.addEvent(this.parent,"mousedown",this.getMouseDown());com.modestmaps.addEvent(this.parent,"mousewheel",this.getMouseWheel());this.loadingLayer=document.createElement("div");this.loadingLayer.id=this.idBase+"loading layer";this.loadingLayer.style.display="none";this.parent.appendChild(this.loadingLayer);this.layers=[];for(var d=0;d<=20;d++){var a=document.createElement("div");a.id=this.idBase+"zoom-"+d;a.style.margin="0";a.style.padding="0";a.style.width="100%";a.style.height="100%";a.style.position="absolute";a.style.top="0px";a.style.left="0px";this.parent.appendChild(a);this.layers.push(a)}this.provider=e;this.dimensions=c;this.coordinate=new com.modestmaps.Coordinate(0.5,0.5,0);this.tiles={};this.requestedTiles={};this.requestCount=0;this.maxSimultaneousRequests=4;this.requestQueue=[];this.tileCacheSize=0;this.callbacks={zoomed:[],panned:[],centered:[],extentset:[]}};com.modestmaps.Map.prototype={parent:null,provider:null,dimensions:null,coordinate:null,tiles:null,requestedTiles:null,layers:null,requestCount:null,maxSimultaneousRequests:null,requestQueue:null,tileCacheSize:null,callbacks:null,toString:function(){return"Map("+this.provider.toString()+this.dimensions.toString()+this.coordinate.toString()+")"},addCallback:function(a,b){if(typeof(b)=="function"&&this.callbacks[a]){this.callbacks[a].push(b)}},dispatchCallback:function(c,b){if(this.callbacks[c]){for(var a=0;a<this.callbacks[c].length;a+=1){try{this.callbacks[c][a](this,b)}catch(d){}}}},createOverlay:function(b){var a=document.createElement("canvas");a.id=b;a.width=this.dimensions.x;a.height=this.dimensions.y;a.style.margin="0";a.style.padding="0";a.style.position="absolute";a.style.top="0px";a.style.left="0px";this.parent.appendChild(a)},mouseDownHandler:null,getMouseDown:function(){if(!this.mouseDownHandler){var a=this;this.mouseDownHandler=function(b){if(!b){var b=window.event}com.modestmaps.addEvent(document,"mouseup",a.getMouseUp());com.modestmaps.addEvent(document,"mousemove",a.getMouseMove());a.prevMouse=new com.modestmaps.Point(b.clientX,b.clientY);a.parent.style.cursor="move";return com.modestmaps.cancelEvent(b)}}return this.mouseDownHandler},mouseMoveHandler:null,getMouseMove:function(){if(!this.mouseMoveHandler){var a=this;this.mouseMoveHandler=function(b){if(!b){b=window.event}if(a.prevMouse){a.panBy(b.clientX-a.prevMouse.x,b.clientY-a.prevMouse.y);a.prevMouse.x=b.clientX;a.prevMouse.y=b.clientY}return com.modestmaps.cancelEvent(b)}}return this.mouseMoveHandler},mouseUpHandler:null,getMouseUp:function(){if(!this.mouseUpHandler){var a=this;this.mouseUpHandler=function(b){if(!b){b=window.event}com.modestmaps.removeEvent(document,"mouseup",a.getMouseUp());com.modestmaps.removeEvent(document,"mousemove",a.getMouseMove());a.prevMouse=null;a.parent.style.cursor="";return com.modestmaps.cancelEvent(b)}}return this.mouseUpHandler},mouseWheelHandler:null,getMouseWheel:function(){if(!this.mouseWheelHandler){var a=this;var b=new Date().getTime();this.mouseWheelHandler=function(f){if(!f){f=window.event}var g=0;if(f.wheelDelta){g=f.wheelDelta}else{if(f.detail){g=-f.detail}}var d=new Date().getTime()-b;if(g!=0&&(d>200)){var c=a.getMousePoint(f);a.zoomByAbout(g>0?1:-1,c);b=new Date().getTime()}return com.modestmaps.cancelEvent(f)}}return this.mouseWheelHandler},doubleClickHandler:null,getDoubleClick:function(){if(!this.doubleClickHandler){var a=this;this.doubleClickHandler=function(c){if(!c){c=window.event}var b=a.getMousePoint(c);a.zoomByAbout(c.shiftKey?-1:1,b);return com.modestmaps.cancelEvent(c)}}return this.doubleClickHandler},getMousePoint:function(c){var a=new com.modestmaps.Point(c.clientX,c.clientY);a.x+=document.body.scrollLeft+document.documentElement.scrollLeft;a.y+=document.body.scrollTop+document.documentElement.scrollTop;for(var b=this.parent;b;b=b.offsetParent){a.x-=b.offsetLeft;a.y-=b.offsetTop}return a},zoomIn:function(){this.zoomBy(1)},zoomOut:function(){this.zoomBy(-1)},setZoom:function(a){this.zoomBy(a-this.coordinate.zoom)},zoomBy:function(a){this.coordinate=this.coordinate.zoomBy(a);this.draw();this.dispatchCallback("zoomed",a)},zoomByAbout:function(b,a){var d=this.pointLocation(a);this.coordinate=this.coordinate.zoomBy(b);var c=this.locationPoint(d);this.panBy(a.x-c.x,a.y-c.y);this.dispatchCallback("zoomed",b)},panBy:function(b,a){this.coordinate.column-=b/this.provider.tileWidth;this.coordinate.row-=a/this.provider.tileHeight;this.draw();this.dispatchCallback("panned",[b,a])},panLeft:function(){this.panBy(100,0)},panRight:function(){this.panBy(-100,0)},panDown:function(){this.panBy(0,-100)},panUp:function(){this.panBy(0,100)},setCenter:function(a){this.setCenterZoom(a,this.coordinate.zoom)},setCenterZoom:function(a,b){this.coordinate=this.provider.locationCoordinate(a).zoomTo(b);this.draw();this.dispatchCallback("centered",[a,b])},setExtent:function(j){var g,f;for(var e=0;e<j.length;e++){var p=this.provider.locationCoordinate(j[e]);if(g){g.row=Math.min(g.row,p.row);g.column=Math.min(g.column,p.column);g.zoom=Math.min(g.zoom,p.zoom);f.row=Math.max(f.row,p.row);f.column=Math.max(f.column,p.column);f.zoom=Math.max(f.zoom,p.zoom)}else{g=p.copy();f=p.copy()}}var b=this.dimensions.x+1;var q=this.dimensions.y+1;var a=(f.column-g.column)/(b/this.provider.tileWidth);var k=Math.log(a)/Math.log(2);var l=g.zoom-Math.ceil(k);var m=(f.row-g.row)/(q/this.provider.tileHeight);var r=Math.log(m)/Math.log(2);var o=g.zoom-Math.ceil(r);var c=Math.min(l,o);var d=(g.row+f.row)/2;var h=(g.column+f.column)/2;var n=g.zoom;this.coordinate=new com.modestmaps.Coordinate(d,h,n).zoomTo(c);this.draw();this.dispatchCallback("extentset",j)},setSize:function(b,a){if(b.hasOwnProperty("x")&&b.hasOwnProperty("y")){this.dimensions=b}else{if(a!==undefined&&!isNaN(a)){this.dimensions=new com.modestmaps.Point(b,a)}}this.parent.style.width=parseInt(this.dimensions.x)+"px";this.parent.style.height=parseInt(this.dimensions.y)+"px";this.draw()},coordinatePoint:function(b){if(b.zoom!=this.coordinate.zoom){b=b.zoomTo(this.coordinate.zoom)}var a=new com.modestmaps.Point(this.dimensions.x/2,this.dimensions.y/2);a.x+=this.provider.tileWidth*(b.column-this.coordinate.column);a.y+=this.provider.tileHeight*(b.row-this.coordinate.row);return a},pointCoordinate:function(a){var b=this.coordinate.copy();b.column+=(a.x-this.dimensions.x/2)/this.provider.tileWidth;b.row+=(a.y-this.dimensions.y/2)/this.provider.tileHeight;return b},locationPoint:function(a){return this.coordinatePoint(this.provider.locationCoordinate(a))},pointLocation:function(a){return this.provider.coordinateLocation(this.pointCoordinate(a))},getExtent:function(){var a=[];a.push(this.pointLocation(new com.modestmaps.Point(0,0)));a.push(this.pointLocation(this.dimensions));return a},getCenter:function(){return this.provider.coordinateLocation(this.coordinate)},getZoom:function(){return this.coordinate.zoom},setProvider:function(c){for(var e in this.requestedTiles){var d=this.requestedTiles[e];this.cancelTileRequest(d);d=null}for(var b=0;b<this.layers.length;b+=1){var a=this.layers[b];while(a.firstChild){a.removeChild(a.firstChild)}}this.tiles={};this.requestedTiles={};this.requestCount=0;this.maxSimultaneousRequests=4;this.requestQueue=[];this.tileCacheSize=0;this.provider=c;this.draw()},draw:function(p){var z=this.coordinate.container();var A=new com.modestmaps.Point(this.dimensions.x/2,this.dimensions.y/2);A.x+=(z.column-this.coordinate.column)*this.provider.tileWidth;A.y+=(z.row-this.coordinate.row)*this.provider.tileHeight;while(A.x>0){A.x-=this.provider.tileWidth;z.column-=1}while(A.y>0){A.y-=this.provider.tileHeight;z.row-=1}var c={};var f=this.layers[parseInt(z.zoom)];f.coordinate=this.coordinate.copy();var l=false;var b=z.copy();var s=this.dimensions.y;var t=this.dimensions.x;var e=this.provider.tileHeight;var n=this.provider.tileWidth;for(var h=A.y;h<s;h+=e){for(var k=A.x;k<t;k+=n){var g=b.toKey();c[g]=true;if(!this.tiles[g]){if(!this.requestedTiles[g]){this.requestTile(b)}l=true;if(!p){for(var m=1;m<=5;m++){var r=b.zoomBy(-m).container().toKey();c[r]=true}var d=b.zoomBy(1);c[d.toKey()]=true;d.column+=1;c[d.toKey()]=true;d.row+=1;c[d.toKey()]=true;d.column-=1;c[d.toKey()]=true}}else{var D=this.tiles[g];if(D.parentNode!=f){f.appendChild(D)}D.style.left=k+"px";D.style.top=h+"px"}b.column+=1}b.row+=1;b.column=z.column}if(!p||!l){for(var q=0;q<z.zoom-5;q++){var C=this.layers[q];C.style.display="none";var w=C.getElementsByTagName("img");for(var o=w.length-1;o>=0;o--){C.removeChild(w[o])}}for(var q=z.zoom+2;q<this.layers.length;q++){var C=this.layers[q];C.style.display="none";var w=C.getElementsByTagName("img");for(var o=w.length-1;o>=0;o--){C.removeChild(w[o])}}for(var q=Math.max(0,z.zoom-5);q<Math.min(z.zoom+2,this.layers.length);q++){var C=this.layers[q];var B=1;var a=null;if(C.coordinate){C.style.display="block";if(C!=f){a=this.coordinate.zoomTo(C.coordinate.zoom);B=Math.pow(2,this.coordinate.zoom-C.coordinate.zoom)}}else{C.style.display="none"}var w=C.getElementsByTagName("img");for(var o=w.length-1;o>=0;o--){var D=w[o];if(!c[D.id]){C.removeChild(D)}else{if(a){var v=((this.dimensions.x/2)+(D.coord.column-a.column)*this.provider.tileWidth*B);var u=((this.dimensions.y/2)+(D.coord.row-a.row)*this.provider.tileHeight*B);D.style.left=parseInt(v)+"px";D.style.top=parseInt(u)+"px";D.width=this.provider.tileWidth*B;D.height=this.provider.tileHeight*B}else{D.width=this.provider.tileWidth;D.height=this.provider.tileHeight}}}}}for(var g in this.requestedTiles){if(!c[g]){var D=this.requestedTiles[g];this.cancelTileRequest(D);D=null}}this.processQueue()},redrawTimer:undefined,requestRedraw:function(){if(this.redrawTimer){clearTimeout(this.redrawTimer)}this.redrawTimer=setTimeout(this.getRedraw(),1000)},_redraw:null,getRedraw:function(){if(!this._redraw){var a=this;this._redraw=function(){a.draw()}}return this._redraw},requestTile:function(a){var c=a.toKey();if(!this.requestedTiles[c]){var b=document.createElement("img");b.id=c;b.width=this.provider.tileWidth;b.height=this.provider.tileHeight;b.style.position="absolute";this.requestedTiles[c]=b;this.requestQueue.push({tile:b,coord:a.copy()})}},processQueue:function(){if(this.requestQueue.length>8){this.requestQueue.sort(this.getCenterDistanceCompare())}while(this.requestCount<this.maxSimultaneousRequests&&this.requestQueue.length>0){var a=this.requestQueue.pop();if(a){this.requestCount++;this.loadingLayer.appendChild(a.tile);a.tile.onload=a.tile.onerror=this.getLoadComplete();a.tile.src=this.provider.getTileUrl(a.coord);a.tile.coord=a.coord;a.tile=a.coord=null}}},cancelTileRequest:function(c){delete this.requestedTiles[c.id];if(c.src){c.onload=c.onerror=null;c.coord=null;c.src=null;this.loadingLayer.removeChild(c);this.requestCount--}else{for(var a=0;a<this.requestQueue.length;a++){var b=this.requestQueue[a];if(b&&b.tile===c){this.requestQueue[a]=null;b.tile=b.coord=null}}}},_loadComplete:null,getLoadComplete:function(){if(!this._loadComplete){var a=this;this._loadComplete=function(c){if(!c){var c=event||window.event}var b=c.srcElement||c.target;b.onload=b.onerror=null;a.loadingLayer.removeChild(b);a.requestCount--;delete a.requestedTiles[b.id];if(b.complete||(b.readyState&&b.readyState=="complete")){a.tiles[b.id]=b;a.tileCacheSize++}else{b.src=null}a.draw(true);a.requestRedraw()}}return this._loadComplete},getCenterDistanceCompare:function(){var a=this.coordinate;return function(d,c){if(d&&c){var f=d.coord;var e=c.coord;var b=Math.abs(a.row-f.row)+Math.abs(a.column-f.column);var g=Math.abs(a.row-e.row)+Math.abs(a.column-e.column);return b<g?1:b>g?-1:0}return d?1:c?-1:0}}};
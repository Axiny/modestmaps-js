/*
 * Modest Maps JS v0.17.0
 * http://modestmaps.com/
 *
 * Copyright (c) 2010 Stamen Design, All Rights Reserved.
 *
 * Open source under the BSD License.
 * http://creativecommons.org/licenses/BSD/
 *
 * Versioned using Semantic Versioning (v.major.minor.patch)
 * See CHANGELOG and http://semver.org/ for more details.
 * 
 */
if(!com){var com={};if(!com.modestmaps){com.modestmaps={}}}(function(a){a.extend=function(d,b){for(var c in b.prototype){if(typeof d.prototype[c]=="undefined"){d.prototype[c]=b.prototype[c]}}return d};a.getFrame=function(){return function(b){(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c){window.setTimeout(function(){c(+new Date())},10)})(b)}}();a.transformProperty=(function(d){var c=document.documentElement.style;for(var b=0;b<d.length;b++){if(d[b] in c){return d[b]}}return false})(["transformProperty","WebkitTransform","OTransform","MozTransform","msTransform"]);a.matrixString=function(b){return"matrix3d("+[(b.scale||"1"),"0,0,0,0",(b.scale||"1"),"0,0,0,0,1,0",b.x,b.y,"0,1"].join(",")+")"};a._browser=(function(){return{webkit:("WebKitCSSMatrix" in window),webkit3d:("WebKitCSSMatrix" in window)&&("m11" in new WebKitCSSMatrix())}})();a.moveElement=function(d,b){if(a._browser.webkit3d){var c=a.matrixString(b);if(d[a.transformProperty]!==c){d.style[a.transformProperty]=d[a.transformProperty]=a.matrixString(b)}}else{d.style.left=b.x+"px";d.style.top=b.y+"px"}};a.cancelEvent=function(b){b.cancelBubble=true;b.cancel=true;b.returnValue=false;if(b.stopPropagation){b.stopPropagation()}if(b.preventDefault){b.preventDefault()}return false};a.addEvent=function(d,c,b){if(d.attachEvent){d["e"+c+b]=b;d[c+b]=function(){d["e"+c+b](window.event)};d.attachEvent("on"+c,d[c+b])}else{d.addEventListener(c,b,false);if(c=="mousewheel"){d.addEventListener("DOMMouseScroll",b,false)}}};a.bind=function(d,f){var g=Array.prototype.slice;var c=Function.prototype.bind;if(d.bind===c&&c){return c.apply(d,g.call(arguments,1))}var b=g.call(arguments,2);return function(){return d.apply(f,b.concat(g.call(arguments)))}};a.removeEvent=function(d,c,b){if(d.detachEvent){d.detachEvent("on"+c,d[c+b]);d[c+b]=null}else{d.removeEventListener(c,b,false);if(c=="mousewheel"){d.removeEventListener("DOMMouseScroll",b,false)}}};a.getStyle=function(c,b){if(c.currentStyle){var d=c.currentStyle[b]}else{if(window.getComputedStyle){var d=document.defaultView.getComputedStyle(c,null).getPropertyValue(b)}}return d};a.Point=function(b,c){this.x=parseFloat(b);this.y=parseFloat(c)};a.Point.prototype={x:0,y:0,toString:function(){return"("+this.x.toFixed(3)+", "+this.y.toFixed(3)+")"}};a.Point.distance=function(f,d){var c=(d.x-f.x);var b=(d.y-f.y);return Math.sqrt(c*c+b*b)};a.Point.interpolate=function(g,f,d){var c=g.x+(f.x-g.x)*d;var b=g.y+(f.y-g.y)*d;return new a.Point(c,b)};a.Coordinate=function(d,b,c){this.row=d;this.column=b;this.zoom=c};a.Coordinate.prototype={row:0,column:0,zoom:0,toString:function(){return"("+this.row.toFixed(3)+", "+this.column.toFixed(3)+" @"+this.zoom.toFixed(3)+")"},toKey:function(){return(1<<this.zoom)*((1<<this.zoom)+this.row)+this.column},copy:function(){return new a.Coordinate(this.row,this.column,this.zoom)},container:function(){return new a.Coordinate(Math.floor(this.row),Math.floor(this.column),Math.floor(this.zoom))},zoomTo:function(b){var c=Math.pow(2,b-this.zoom);return new a.Coordinate(this.row*c,this.column*c,b)},zoomBy:function(c){var b=Math.pow(2,c);return new a.Coordinate(this.row*b,this.column*b,this.zoom+c)},up:function(b){if(b===undefined){b=1}return new a.Coordinate(this.row-b,this.column,this.zoom)},right:function(b){if(b===undefined){b=1}return new a.Coordinate(this.row,this.column+b,this.zoom)},down:function(b){if(b===undefined){b=1}return new a.Coordinate(this.row+b,this.column,this.zoom)},left:function(b){if(b===undefined){b=1}return new a.Coordinate(this.row,this.column-b,this.zoom)}};a.Location=function(b,c){this.lat=parseFloat(b);this.lon=parseFloat(c)};a.Location.prototype={lat:0,lon:0,toString:function(){return"("+this.lat.toFixed(3)+", "+this.lon.toFixed(3)+")"}};a.Location.distance=function(i,h,b){if(!b){b=6378000}var o=Math.PI/180,g=i.lat*o,n=i.lon*o,f=h.lat*o,m=h.lon*o,l=Math.cos(g)*Math.cos(n)*Math.cos(f)*Math.cos(m),k=Math.cos(g)*Math.sin(n)*Math.cos(f)*Math.sin(m),j=Math.sin(g)*Math.sin(f);return Math.acos(l+k+j)*b};a.Location.interpolate=function(j,h,n){var t=Math.PI/180,l=j.lat*t,o=j.lon*t,k=h.lat*t,m=h.lon*t;var p=2*Math.asin(Math.sqrt(Math.pow(Math.sin((l-k)/2),2)+Math.cos(l)*Math.cos(k)*Math.pow(Math.sin((o-m)/2),2)));var u=Math.atan2(Math.sin(o-m)*Math.cos(k),Math.cos(l)*Math.sin(k)-Math.sin(l)*Math.cos(k)*Math.cos(o-m))/-(Math.PI/180);u=u<0?360+u:u;var g=Math.sin((1-n)*p)/Math.sin(p);var b=Math.sin(n*p)/Math.sin(p);var s=g*Math.cos(l)*Math.cos(o)+b*Math.cos(k)*Math.cos(m);var r=g*Math.cos(l)*Math.sin(o)+b*Math.cos(k)*Math.sin(m);var q=g*Math.sin(l)+b*Math.sin(k);var c=Math.atan2(q,Math.sqrt(Math.pow(s,2)+Math.pow(r,2)));var i=Math.atan2(r,s);return new a.Location(c/t,i/t)};a.Transformation=function(d,g,b,c,f,h){this.ax=d;this.bx=g;this.cx=b;this.ay=c;this.by=f;this.cy=h};a.Transformation.prototype={ax:0,bx:0,cx:0,ay:0,by:0,cy:0,transform:function(b){return new a.Point(this.ax*b.x+this.bx*b.y+this.cx,this.ay*b.x+this.by*b.y+this.cy)},untransform:function(b){return new a.Point((b.x*this.by-b.y*this.bx-this.cx*this.by+this.cy*this.bx)/(this.ax*this.by-this.ay*this.bx),(b.x*this.ay-b.y*this.ax-this.cx*this.ay+this.cy*this.ax)/(this.bx*this.ay-this.by*this.ax))}};a.deriveTransformation=function(m,l,g,f,b,p,i,h,d,c,o,n){var k=a.linearSolution(m,l,g,b,p,i,d,c,o);var j=a.linearSolution(m,l,f,b,p,h,d,c,n);return new a.Transformation(k[0],k[1],k[2],j[0],j[1],j[2])};a.linearSolution=function(g,p,j,f,o,i,d,n,h){g=parseFloat(g);p=parseFloat(p);j=parseFloat(j);f=parseFloat(f);o=parseFloat(o);i=parseFloat(i);d=parseFloat(d);n=parseFloat(n);h=parseFloat(h);var m=(((i-h)*(p-o))-((j-i)*(o-n)))/(((f-d)*(p-o))-((g-f)*(o-n)));var l=(((i-h)*(g-f))-((j-i)*(f-d)))/(((o-n)*(g-f))-((p-o)*(f-d)));var k=j-(g*m)-(p*l);return[m,l,k]};a.Projection=function(c,b){if(!b){b=new a.Transformation(1,0,0,0,1,0)}this.zoom=c;this.transformation=b};a.Projection.prototype={zoom:0,transformation:null,rawProject:function(b){throw"Abstract method not implemented by subclass."},rawUnproject:function(b){throw"Abstract method not implemented by subclass."},project:function(b){b=this.rawProject(b);if(this.transformation){b=this.transformation.transform(b)}return b},unproject:function(b){if(this.transformation){b=this.transformation.untransform(b)}b=this.rawUnproject(b);return b},locationCoordinate:function(c){var b=new a.Point(Math.PI*c.lon/180,Math.PI*c.lat/180);b=this.project(b);return new a.Coordinate(b.y,b.x,this.zoom)},coordinateLocation:function(c){c=c.zoomTo(this.zoom);var b=new a.Point(c.column,c.row);b=this.unproject(b);return new a.Location(180*b.y/Math.PI,180*b.x/Math.PI)}};a.LinearProjection=function(c,b){a.Projection.call(this,c,b)};a.LinearProjection.prototype={rawProject:function(b){return new a.Point(b.x,b.y)},rawUnproject:function(b){return new a.Point(b.x,b.y)}};a.extend(a.LinearProjection,a.Projection);a.MercatorProjection=function(c,b){a.Projection.call(this,c,b)};a.MercatorProjection.prototype={rawProject:function(b){return new a.Point(b.x,Math.log(Math.tan(0.25*Math.PI+0.5*b.y)))},rawUnproject:function(b){return new a.Point(b.x,2*Math.atan(Math.pow(Math.E,b.y))-0.5*Math.PI)}};a.extend(a.MercatorProjection,a.Projection);a.MapProvider=function(b){if(b){this.getTileUrl=b}};a.MapProvider.prototype={projection:new a.MercatorProjection(0,a.deriveTransformation(-Math.PI,Math.PI,0,0,Math.PI,Math.PI,1,0,-Math.PI,-Math.PI,0,1)),tileWidth:256,tileHeight:256,topLeftOuterLimit:new a.Coordinate(0,0,0),bottomRightInnerLimit:new a.Coordinate(1,1,0).zoomTo(18),getTileUrl:function(b){throw"Abstract method not implemented by subclass."},locationCoordinate:function(b){return this.projection.locationCoordinate(b)},coordinateLocation:function(b){return this.projection.coordinateLocation(b)},outerLimits:function(){return[this.topLeftOuterLimit.copy(),this.bottomRightInnerLimit.copy()]},setZoomRange:function(c,b){this.topLeftOuterLimit=this.topLeftOuterLimit.zoomTo(c);this.bottomRightInnerLimit=this.bottomRightInnerLimit.zoomTo(b)},sourceCoordinate:function(h){var b=this.topLeftOuterLimit.zoomTo(h.zoom);var d=this.bottomRightInnerLimit.zoomTo(h.zoom);var c=d.row-b.row;if(h.row<0|h.row>=c){return null}var g=d.column-b.column;var f=h.column%g;while(f<0){f+=g}return new a.Coordinate(h.row,f,h.zoom)}};a.TemplatedMapProvider=function(c,b){a.MapProvider.call(this,function(g){g=this.sourceCoordinate(g);if(!g){return null}var d=c;if(b&&b.length&&d.indexOf("{S}")>=0){var f=parseInt(g.zoom+g.row+g.column,10)%b.length;d=d.replace("{S}",b[f])}return d.replace("{Z}",g.zoom.toFixed(0)).replace("{X}",g.column.toFixed(0)).replace("{Y}",g.row.toFixed(0))})};a.extend(a.TemplatedMapProvider,a.MapProvider);a.getMousePoint=function(f,d){var b=new a.Point(f.clientX,f.clientY);b.x+=document.body.scrollLeft+document.documentElement.scrollLeft;b.y+=document.body.scrollTop+document.documentElement.scrollTop;for(var c=d.parent;c;c=c.offsetParent){b.x-=c.offsetLeft;b.y-=c.offsetTop}return b};a.MouseWheelHandler=function(b){if(b!==undefined){this.init(b)}};a.MouseWheelHandler.prototype={init:function(b){this.map=b;a.addEvent(b.parent,"mousewheel",a.bind(this.mouseWheel,this))},mouseWheel:function(d){var f=0;this.prevTime=this.prevTime||new Date().getTime();if(d.wheelDelta){f=d.wheelDelta}else{if(d.detail){f=-d.detail}}var c=new Date().getTime()-this.prevTime;if(Math.abs(f)>0&&(c>200)){var b=a.getMousePoint(d,this.map);this.map.zoomByAbout(f>0?1:-1,b);this.prevTime=new Date().getTime()}return a.cancelEvent(d)}};a.DoubleClickHandler=function(b){if(b!==undefined){this.init(b)}};a.DoubleClickHandler.prototype={init:function(b){this.map=b;a.addEvent(b.parent,"dblclick",this._doubleClick=a.bind(this.doubleClick,this))},doubleClick:function(){var b=a.getMousePoint(e,this.map);this.map.zoomByAbout(e.shiftKey?-1:1,b);return a.cancelEvent(e)}};a.DragHandler=function(b){if(b!==undefined){this.init(b)}};a.DragHandler.prototype={init:function(b){this.map=b;a.addEvent(b.parent,"mousedown",a.bind(this.mouseDown,this))},mouseDown:function(b){a.addEvent(document,"mouseup",this._mouseUp=a.bind(this.mouseUp,this));a.addEvent(document,"mousemove",this._mouseMove=a.bind(this.mouseMove,this));this.prevMouse=new a.Point(b.clientX,b.clientY);this.map.parent.style.cursor="move";return a.cancelEvent(b)},mouseMove:function(b){if(this.prevMouse){this.map.panBy(b.clientX-this.prevMouse.x,b.clientY-this.prevMouse.y);this.prevMouse.x=b.clientX;this.prevMouse.y=b.clientY}return a.cancelEvent(b)},mouseUp:function(b){a.removeEvent(document,"mouseup",this._mouseUp);a.removeEvent(document,"mousemove",this._mouseMove);this.prevMouse=null;this.map.parent.style.cursor="";return a.cancelEvent(b)}};a.MouseHandler=function(b){if(b!==undefined){this.init(b)}};a.MouseHandler.prototype={init:function(b){this.map=b;new a.DragHandler(b);new a.DoubleClickHandler(b);new a.MouseWheelHandler(b)}};a.TouchHandler=function(){};a.TouchHandler.prototype={maxTapTime:150,maxTapDistance:10,maxDoubleTapDelay:350,locations:{},coordinate:null,taps:[],init:function(c,b){this.map=c;b=b||{};a.addEvent(c.parent,"touchstart",a.bind(this.touchStartMachine,this));a.addEvent(c.parent,"touchmove",a.bind(this.touchMoveMachine,this));a.addEvent(c.parent,"touchend",a.bind(this.touchEndMachine,this));this.options={};this.options.snapToZoom=b.snapToZoom||true},interruptTouches:function(d){for(var c=0;c<d.touches.length;c+=1){var b=d.touches[c];this.locations[b.identifier]={screenX:b.screenX,screenY:b.screenY,time:+new Date()}}},sameTouch:function(b,c){return(b&&b.touch)&&(c.identifier==b.touch.identifier)},distance:function(c,b){return Math.sqrt(Math.pow(c.screenX-b.screenX,2)+Math.pow(c.screenY-b.screenY,2))},twoTouchMatrix:function(g){var f=g.touches[0],d=g.touches[1],b=this.locations[f.identifier],h=this.locations[d.identifier],k=(f.screenX+d.screenX)/2,i=(f.screenY+d.screenY)/2,c=(b.screenX+h.screenX)/2,j=(b.screenY+h.screenY)/2;return{x:g.scale*-c+k,y:g.scale*-i+i}},touchStartMachine:function(b){this.interruptTouches(b);this.coordinate=this.map.coordinate.copy();return a.cancelEvent(b)},touchMoveMachine:function(c){var b=new Date().getTime();switch(c.touches.length){case 1:this.onPanning(c.touches[0]);break;case 2:this.onPinching(c);break}return a.cancelEvent(c)},touchEndMachine:function(g){var b=new Date().getTime();switch(g.changedTouches.length){case 1:break;case 2:this.onPinched(g);break}for(var d=0;d<g.changedTouches.length;d+=1){var c=g.changedTouches[d];var j=this.locations[c.identifier];if(!j){return}var f=b-j.time;var h=this.distance(c,j);if(h>this.maxTapDistance){}else{if(f>this.maxTapTime){this.onHold({x:c.screenX,y:c.screenY,end:b,duration:f})}else{this.onTap({x:c.screenX,y:c.screenY,time:b})}}}this.locations={};return a.cancelEvent(g)},onHold:function(b){},onTap:function(b){if(this.taps.length&&(b.time-this.taps[0].time)<this.maxDoubleTapDelay){this.onDoubleTap(b);return}this.taps=[b]},onDoubleTap:function(b){var d=Math.floor(this.map.getZoom()+2);d=d-this.map.getZoom();var c=new a.Point(b.x,b.y);this.map.zoomByAbout(d,c)},onPanning:function(c){var b=this.locations[c.identifier];this.map.coordinate=this.coordinate.copy();this.map.panBy(c.screenX-b.screenX,c.screenY-b.screenY)},onPanned:function(b){},onPinching:function(c){var b=this.twoTouchMatrix(c);this.map.zoomBy(Math.log(c.scale)/Math.LN2+this.coordinate.zoom-this.map.getZoom())},onPinched:function(c,b){if(this.options.snapToZoom){this.map.setZoom(Math.round(this.map.getZoom()))}}};a.CallbackManager=function(b,d){this.owner=b;this.callbacks={};for(var c=0;c<d.length;c++){this.callbacks[d[c]]=[]}};a.CallbackManager.prototype={owner:null,callbacks:null,addCallback:function(b,c){if(typeof(c)=="function"&&this.callbacks[b]){this.callbacks[b].push(c)}},removeCallback:function(f,g){if(typeof(g)=="function"&&this.callbacks[f]){var c=this.callbacks[f],b=c.length;for(var d=0;d<b;d++){if(c[d]===g){c.splice(d,1);break}}}},dispatchCallback:function(d,c){if(this.callbacks[d]){for(var b=0;b<this.callbacks[d].length;b+=1){try{this.callbacks[d][b](this.owner,c)}catch(f){}}}}};a.RequestManager=function(b){this.loadingBay=document.createDocumentFragment();this.requestsById={};this.openRequestCount=0;this.maxOpenRequests=4;this.requestQueue=[];this.callbackManager=new a.CallbackManager(this,["requestcomplete"])};a.RequestManager.prototype={loadingBay:null,requestsById:null,requestQueue:null,openRequestCount:null,maxOpenRequests:null,callbackManager:null,addCallback:function(b,c){this.callbackManager.addCallback(b,c)},removeCallback:function(b,c){this.callbackManager.removeCallback(b,c)},dispatchCallback:function(c,b){this.callbackManager.dispatchCallback(c,b)},clear:function(){this.clearExcept({})},clearExcept:function(h){for(var f=0;f<this.requestQueue.length;f++){var g=this.requestQueue[f];if(g&&!(g.key in h)){this.requestQueue[f]=null}}var b=this.loadingBay.childNodes;for(var d=b.length-1;d>=0;d--){var c=b[d];if(!(c.id in h)){this.loadingBay.removeChild(c);this.openRequestCount--;c.src=c.coord=c.onload=c.onerror=null}}for(var k in this.requestsById){if(this.requestsById.hasOwnProperty(k)){if(!(k in h)){var g=this.requestsById[k];delete this.requestsById[k];if(g!==null){g=g.key=g.coord=g.url=null}}}}},hasRequest:function(b){return(b in this.requestsById)},requestTile:function(c,f,b){if(!(c in this.requestsById)){var d={key:c,coord:f.copy(),url:b};this.requestsById[c]=d;if(b){this.requestQueue.push(d)}}},getProcessQueue:function(){if(!this._processQueue){var b=this;this._processQueue=function(){b.processQueue()}}return this._processQueue},processQueue:function(d){if(d&&this.requestQueue.length>8){this.requestQueue.sort(d)}while(this.openRequestCount<this.maxOpenRequests&&this.requestQueue.length>0){var c=this.requestQueue.pop();if(c){this.openRequestCount++;var b=document.createElement("img");b.id=c.key;b.style.position="absolute";b.coord=c.coord;this.loadingBay.appendChild(b);b.onload=b.onerror=this.getLoadComplete();b.src=c.url;c=c.key=c.coord=c.url=null}}},_loadComplete:null,getLoadComplete:function(){if(!this._loadComplete){var b=this;this._loadComplete=function(d){d=d||window.event;var c=d.srcElement||d.target;c.onload=c.onerror=null;b.loadingBay.removeChild(c);b.openRequestCount--;delete b.requestsById[c.id];if(d.type==="load"&&(c.complete||(c.readyState&&c.readyState=="complete"))){b.dispatchCallback("requestcomplete",c)}else{c.src=null}setTimeout(b.getProcessQueue(),0)}}return this._loadComplete}};a.Map=function(l,k,b,c){if(typeof l=="string"){l=document.getElementById(l);if(!l){throw"The ID provided to modest maps could not be found."}}this.parent=l;this.parent.style.padding="0";this.parent.style.overflow="hidden";var j=a.getStyle(this.parent,"position");if(j!="relative"&&j!="absolute"){this.parent.style.position="relative"}if(!b){var m=this.parent.offsetWidth;var g=this.parent.offsetHeight;if(!m){m=640;this.parent.style.width=m+"px"}if(!g){g=480;this.parent.style.height=g+"px"}b=new a.Point(m,g);var d=this;a.addEvent(window,"resize",function(h){d.dimensions=new a.Point(d.parent.offsetWidth,d.parent.offsetHeight);d.draw();d.dispatchCallback("resized",[d.dimensions])})}else{this.parent.style.width=Math.round(b.x)+"px";this.parent.style.height=Math.round(b.y)+"px"}this.dimensions=b;this.requestManager=new a.RequestManager(this.parent);this.requestManager.addCallback("requestcomplete",this.getTileComplete());this.layers={};this.layerParent=document.createElement("div");this.layerParent.id=this.parent.id+"-layers";this.layerParent.style.cssText="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0; z-index: 0";this.parent.appendChild(this.layerParent);this.coordinate=new a.Coordinate(0.5,0.5,0);this.setProvider(k);this.enablePyramidLoading=false;this.callbackManager=new a.CallbackManager(this,["zoomed","panned","centered","extentset","resized","drawn"]);if(c===undefined){this.eventHandlers=[];this.eventHandlers.push(new a.MouseHandler(this))}else{this.eventHandlers=c;if(c instanceof Array){for(var f=0;f<c.length;f++){c[f].init(this)}}}};a.Map.prototype={parent:null,provider:null,dimensions:null,coordinate:null,tiles:null,layers:null,layerParent:null,requestManager:null,tileCacheSize:null,maxTileCacheSize:null,recentTiles:null,recentTilesById:null,recentTileSize:null,callbackManager:null,eventHandlers:null,toString:function(){return"Map(#"+this.parent.id+")"},addCallback:function(b,c){this.callbackManager.addCallback(b,c)},removeCallback:function(b,c){this.callbackManager.removeCallback(b,c)},dispatchCallback:function(c,b){this.callbackManager.dispatchCallback(c,b)},zoomBy:function(b){this.coordinate=this.coordinate.zoomBy(b);this.draw();this.dispatchCallback("zoomed",b);return this},zoomIn:function(){return this.zoomBy(1)},zoomOut:function(){return this.zoomBy(-1)},setZoom:function(b){return this.zoomBy(b-this.coordinate.zoom)},zoomByAbout:function(c,b){var f=this.pointLocation(b);this.zoomBy(c);var d=this.locationPoint(f);return this.panBy(b.x-d.x,b.y-d.y)},panBy:function(d,b){var c=this;this.coordinate.column-=d/this.provider.tileWidth;this.coordinate.row-=b/this.provider.tileHeight;a.getFrame(function(){c.draw()});this.dispatchCallback("panned",[d,b]);return this},panZoom:function(d,b,f){var c=this;this.coordinate.column-=d/this.provider.tileWidth;this.coordinate.row-=b/this.provider.tileHeight;this.coordinate=this.coordinate.zoomTo(f);a.getFrame(function(){c.draw()});this.dispatchCallback("panned",[d,b]);return this},panLeft:function(){return this.panBy(100,0)},panRight:function(){return this.panBy(-100,0)},panDown:function(){return this.panBy(0,-100)},panUp:function(){return this.panBy(0,100)},setCenter:function(b){return this.setCenterZoom(b,this.coordinate.zoom)},setCenterZoom:function(b,c){this.coordinate=this.provider.locationCoordinate(b).zoomTo(parseFloat(c)||0);this.draw();this.dispatchCallback("centered",[b,c]);return this},setExtent:function(l){var j,h;for(var g=0;g<l.length;g++){var r=this.provider.locationCoordinate(l[g]);if(j){j.row=Math.min(j.row,r.row);j.column=Math.min(j.column,r.column);j.zoom=Math.min(j.zoom,r.zoom);h.row=Math.max(h.row,r.row);h.column=Math.max(h.column,r.column);h.zoom=Math.max(h.zoom,r.zoom)}else{j=r.copy();h=r.copy()}}var c=this.dimensions.x+1;var s=this.dimensions.y+1;var b=(h.column-j.column)/(c/this.provider.tileWidth);var m=Math.log(b)/Math.log(2);var n=j.zoom-Math.ceil(m);var o=(h.row-j.row)/(s/this.provider.tileHeight);var t=Math.log(o)/Math.log(2);var q=j.zoom-Math.ceil(t);var d=Math.min(n,q);d=Math.min(d,this.provider.outerLimits()[1].zoom);d=Math.max(d,this.provider.outerLimits()[0].zoom);var f=(j.row+h.row)/2;var k=(j.column+h.column)/2;var p=j.zoom;this.coordinate=new a.Coordinate(f,k,p).zoomTo(d);this.draw();this.dispatchCallback("extentset",l);return this},setSize:function(c,b){if(c.hasOwnProperty("x")&&c.hasOwnProperty("y")){this.dimensions=c}else{if(b!==undefined&&!isNaN(b)){this.dimensions=new a.Point(c,b)}}this.parent.style.width=Math.round(this.dimensions.x)+"px";this.parent.style.height=Math.round(this.dimensions.y)+"px";this.draw();this.dispatchCallback("resized",[this.dimensions]);return this},coordinatePoint:function(c){if(c.zoom!=this.coordinate.zoom){c=c.zoomTo(this.coordinate.zoom)}var b=new a.Point(this.dimensions.x/2,this.dimensions.y/2);b.x+=this.provider.tileWidth*(c.column-this.coordinate.column);b.y+=this.provider.tileHeight*(c.row-this.coordinate.row);return b},pointCoordinate:function(b){var c=this.coordinate.copy();c.column+=(b.x-this.dimensions.x/2)/this.provider.tileWidth;c.row+=(b.y-this.dimensions.y/2)/this.provider.tileHeight;return c},locationPoint:function(b){return this.coordinatePoint(this.provider.locationCoordinate(b))},pointLocation:function(b){return this.provider.coordinateLocation(this.pointCoordinate(b))},getExtent:function(){var b=[];b.push(this.pointLocation(new a.Point(0,0)));b.push(this.pointLocation(this.dimensions));return b},getCenter:function(){return this.provider.coordinateLocation(this.coordinate)},getZoom:function(){return this.coordinate.zoom},setProvider:function(d){var f=false;if(this.provider===null){f=true}if(!f){this.requestManager.clear();for(var b in this.layers){if(this.layers.hasOwnProperty(b)){var c=this.layers[b];while(c.firstChild){c.removeChild(c.firstChild)}}}}this.tiles={};this.tileCacheSize=0;this.maxTileCacheSize=64;this.recentTiles=[];this.recentTilesById={};this.provider=d;if(!f){this.draw()}return this},enforceLimits:function(f){f=f.copy();var c=this.provider.outerLimits();if(c){var d=c[0].zoom;var b=c[1].zoom;if(f.zoom<d){f=f.zoomTo(d)}else{if(f.zoom>b){f=f.zoomTo(b)}}}return f},draw:function(){this.coordinate=this.enforceLimits(this.coordinate);var p=Math.round(this.coordinate.zoom);var v=this.pointCoordinate(new a.Point(0,0)).zoomTo(p).container();var t=this.pointCoordinate(this.dimensions).zoomTo(p).container().right().down();var l=0;if(l){v=v.left(l).up(l);t=t.right(l).down(l)}var F={};var m=this.createOrGetLayer(v.zoom);var f=v.copy();for(f.column=v.column;f.column<=t.column;f.column+=1){for(f.row=v.row;f.row<=t.row;f.row+=1){var n=f.toKey();F[n]=true;if(n in this.tiles){var I=this.tiles[n];if(I.parentNode!=m){m.appendChild(I)}}else{if(!this.requestManager.hasRequest(n)){var o=this.provider.getTileUrl(f);this.requestManager.requestTile(n,f,o)}var r=false;var E=f.zoom;for(var s=1;s<=E;s++){var u=f.zoomBy(-s).container();var z=u.toKey();if(this.enablePyramidLoading){F[z]=true;var A=this.createOrGetLayer(u.zoom);if(z in this.tiles){var w=this.tiles[z];if(w.parentNode!=A){A.appendChild(w)}}else{if(!this.requestManager.hasRequest(z)){var o=this.provider.getTileUrl(u);this.requestManager.requestTile(z,u,o)}}}else{if(z in this.tiles){F[z]=true;r=true;break}}}if(!r&&!this.enablePyramidLoading){var k=f.zoomBy(1);F[k.toKey()]=true;k.column+=1;F[k.toKey()]=true;k.row+=1;F[k.toKey()]=true;k.column-=1;F[k.toKey()]=true}}}}for(var J in this.layers){if(this.layers.hasOwnProperty(J)){var d=parseInt(J,10);if(d>=v.zoom-5&&d<v.zoom+2){continue}var H=this.layers[J];H.style.display="none";var D=H.getElementsByTagName("img");for(var x=D.length-1;x>=0;x--){H.removeChild(D[x])}}}var g=new Date().getTime();var B=v.zoom-5;var h=v.zoom+2;for(var y=B;y<h;y++){var H=this.layers[y];if(!H){continue}var G=1;var c=this.coordinate.copy();var D=H.getElementsByTagName("img");if(D.length>0){H.style.display="block";G=Math.pow(2,this.coordinate.zoom-y);c=c.zoomTo(y)}else{H.style.display="none"}var b=this.provider.tileWidth*G;var q=this.provider.tileHeight*G;var C=new a.Point(this.dimensions.x/2,this.dimensions.y/2);for(var x=D.length-1;x>=0;x--){var I=D[x];if(!F[I.id]){H.removeChild(I)}else{a.moveElement(I,{x:Math.round(C.x+(I.coord.column-c.column)*b),y:Math.round(C.y+(I.coord.row-c.row)*q),scale:G.toFixed(5)});this.recentTilesById[I.id].lastTouchedTime=g}}}this.requestManager.clearExcept(F);this.requestManager.processQueue(this.getCenterDistanceCompare());this.checkCache();this.dispatchCallback("drawn")},_tileComplete:null,getTileComplete:function(){if(!this._tileComplete){var b=this;this._tileComplete=function(h,i){b.tiles[i.id]=i;b.tileCacheSize++;var f={id:i.id,lastTouchedTime:new Date().getTime()};b.recentTilesById[i.id]=f;b.recentTiles.push(f);var g=b.coordinate.zoomTo(i.coord.zoom);var k=Math.pow(2,b.coordinate.zoom-i.coord.zoom);var d=((b.dimensions.x/2)+(i.coord.column-g.column)*b.provider.tileWidth*k);var c=((b.dimensions.y/2)+(i.coord.row-g.row)*b.provider.tileHeight*k);a.moveElement(i,{x:Math.round(d),y:Math.round(c),scale:k});var j=b.layers[i.coord.zoom];j.appendChild(i);i.className="map-tile-loaded";if(Math.round(b.coordinate.zoom)===i.coord.zoom){j.style.display="block"}b.requestRedraw()}}return this._tileComplete},_redrawTimer:undefined,requestRedraw:function(){if(!this._redrawTimer){this._redrawTimer=setTimeout(this.getRedraw(),1000)}},_redraw:null,getRedraw:function(){if(!this._redraw){var b=this;this._redraw=function(){b.draw();b._redrawTimer=0}}return this._redraw},createOrGetLayer:function(c){if(c in this.layers){return this.layers[c]}var b=document.createElement("div");b.id=this.parent.id+"-zoom-"+c;b.style.cssText=this.layerParent.style.cssText;b.style.zIndex=c;this.layerParent.appendChild(b);this.layers[c]=b;return b},checkCache:function(){var g=this.parent.getElementsByTagName("img").length;var d=Math.max(g,this.maxTileCacheSize);if(this.tileCacheSize>d){this.recentTiles.sort(function(i,h){return h.lastTouchedTime<i.lastTouchedTime?-1:h.lastTouchedTime>i.lastTouchedTime?1:0})}while(this.tileCacheSize>d){var c=this.recentTiles.pop();var b=new Date().getTime();delete this.recentTilesById[c.id];var f=this.tiles[c.id];if(f.parentNode){alert("Gah: trying to removing cached tile even though it's still in the DOM")}else{delete this.tiles[c.id];this.tileCacheSize--}}},getCenterDistanceCompare:function(){var b=this.coordinate.zoomTo(Math.round(this.coordinate.zoom));return function(f,d){if(f&&d){var h=f.coord;var g=d.coord;if(h.zoom==g.zoom){var c=Math.abs(b.row-h.row-0.5)+Math.abs(b.column-h.column-0.5);var i=Math.abs(b.row-g.row-0.5)+Math.abs(b.column-g.column-0.5);return c<i?1:c>i?-1:0}else{return h.zoom<g.zoom?1:h.zoom>g.zoom?-1:0}}return f?1:d?-1:0}}};if(typeof module!=="undefined"&&module.exports){module.exports={Point:a.Point,Projection:a.Projection,MercatorProjection:a.MercatorProjection,LinearProjection:a.LinearProjection,Transformation:a.Transformation,Location:a.Location,MapProvider:a.MapProvider,TemplatedMapProvider:a.TemplatedMapProvider,Coordinate:a.Coordinate}}})(com.modestmaps);
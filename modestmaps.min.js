/*
 * Modest Maps JS v0.16.1
 * http://modestmaps.com/
 *
 * Copyright (c) 2010 Stamen Design, All Rights Reserved.
 *
 * Open source under the BSD License.
 * http://creativecommons.org/licenses/BSD/
 *
 * Versioned using Semantic Versioning (v.major.minor.patch)
 * See CHANGELOG and http://semver.org/ for more details.
 * 
 */
if(!com){var com={};if(!com.modestmaps){com.modestmaps={}}}(function(h){h.extend=function(k,i){for(var j in i.prototype){if(typeof k.prototype[j]=="undefined"){k.prototype[j]=i.prototype[j]}}return k};h.cancelEvent=function(i){i.cancelBubble=true;i.cancel=true;i.returnValue=false;if(i.stopPropagation){i.stopPropagation()}if(i.preventDefault){i.preventDefault()}return false};h.addEvent=function(k,j,i){if(k.attachEvent){k["e"+j+i]=i;k[j+i]=function(){k["e"+j+i](window.event)};k.attachEvent("on"+j,k[j+i])}else{k.addEventListener(j,i,false);if(j=="mousewheel"){k.addEventListener("DOMMouseScroll",i,false)}}};h.removeEvent=function(k,j,i){if(k.detachEvent){k.detachEvent("on"+j,k[j+i]);k[j+i]=null}else{k.removeEventListener(j,i,false);if(j=="mousewheel"){k.removeEventListener("DOMMouseScroll",i,false)}}};h.getStyle=function(j,i){if(j.currentStyle){var k=j.currentStyle[i]}else{if(window.getComputedStyle){var k=document.defaultView.getComputedStyle(j,null).getPropertyValue(i)}}return k};h.Point=function(i,j){this.x=parseFloat(i);this.y=parseFloat(j)};h.Point.prototype={x:0,y:0,toString:function(){return"("+this.x.toFixed(3)+", "+this.y.toFixed(3)+")"}};h.Point.distance=function(l,k){var j=(k.x-l.x);var i=(k.y-l.y);return Math.sqrt(j*j+i*i)};h.Point.interpolate=function(m,l,k){var j=m.x+(l.x-m.x)*k;var i=m.y+(l.y-m.y)*k;return new h.Point(j,i)};h.Coordinate=function(k,i,j){this.row=k;this.column=i;this.zoom=j};h.Coordinate.prototype={row:0,column:0,zoom:0,toString:function(){return"("+this.row.toFixed(3)+", "+this.column.toFixed(3)+" @"+this.zoom.toFixed(3)+")"},toKey:function(){return[Math.floor(this.zoom),Math.floor(this.column),Math.floor(this.row)].join(",")},copy:function(){return new h.Coordinate(this.row,this.column,this.zoom)},container:function(){return new h.Coordinate(Math.floor(this.row),Math.floor(this.column),Math.floor(this.zoom))},zoomTo:function(i){var j=Math.pow(2,i-this.zoom);return new h.Coordinate(this.row*j,this.column*j,i)},zoomBy:function(j){var i=Math.pow(2,j);return new h.Coordinate(this.row*i,this.column*i,this.zoom+j)},up:function(i){if(i===undefined){i=1}return new h.Coordinate(this.row-i,this.column,this.zoom)},right:function(i){if(i===undefined){i=1}return new h.Coordinate(this.row,this.column+i,this.zoom)},down:function(i){if(i===undefined){i=1}return new h.Coordinate(this.row+i,this.column,this.zoom)},left:function(i){if(i===undefined){i=1}return new h.Coordinate(this.row,this.column-i,this.zoom)}};h.Location=function(i,j){this.lat=parseFloat(i);this.lon=parseFloat(j)};h.Location.prototype={lat:0,lon:0,toString:function(){return"("+this.lat.toFixed(3)+", "+this.lon.toFixed(3)+")"}};h.Location.distance=function(m,l,i){if(!i){i=6378000}var t=Math.PI/180,k=m.lat*t,s=m.lon*t,j=l.lat*t,q=l.lon*t,p=Math.cos(k)*Math.cos(s)*Math.cos(j)*Math.cos(q),o=Math.cos(k)*Math.sin(s)*Math.cos(j)*Math.sin(q),n=Math.sin(k)*Math.sin(j);return Math.acos(p+o+n)*i};h.Location.interpolate=function(n,l,r){var C=Math.PI/180,p=n.lat*C,s=n.lon*C,o=l.lat*C,q=l.lon*C;var t=2*Math.asin(Math.sqrt(Math.pow(Math.sin((p-o)/2),2)+Math.cos(p)*Math.cos(o)*Math.pow(Math.sin((s-q)/2),2)));var D=Math.atan2(Math.sin(s-q)*Math.cos(o),Math.cos(p)*Math.sin(o)-Math.sin(p)*Math.cos(o)*Math.cos(s-q))/-(Math.PI/180);D=D<0?360+D:D;var k=Math.sin((1-r)*t)/Math.sin(t);var i=Math.sin(r*t)/Math.sin(t);var w=k*Math.cos(p)*Math.cos(s)+i*Math.cos(o)*Math.cos(q);var v=k*Math.cos(p)*Math.sin(s)+i*Math.cos(o)*Math.sin(q);var u=k*Math.sin(p)+i*Math.sin(o);var j=Math.atan2(u,Math.sqrt(Math.pow(w,2)+Math.pow(v,2)));var m=Math.atan2(v,w);return new h.Location(j/C,m/C)};h.Transformation=function(k,m,i,j,l,n){this.ax=k;this.bx=m;this.cx=i;this.ay=j;this.by=l;this.cy=n};h.Transformation.prototype={ax:0,bx:0,cx:0,ay:0,by:0,cy:0,transform:function(i){return new h.Point(this.ax*i.x+this.bx*i.y+this.cx,this.ay*i.x+this.by*i.y+this.cy)},untransform:function(i){return new h.Point((i.x*this.by-i.y*this.bx-this.cx*this.by+this.cy*this.bx)/(this.ax*this.by-this.ay*this.bx),(i.x*this.ay-i.y*this.ax-this.cx*this.ay+this.cy*this.ax)/(this.bx*this.ay-this.by*this.ax))}};h.deriveTransformation=function(s,r,m,l,i,v,o,n,k,j,u,t){var q=h.linearSolution(s,r,m,i,v,o,k,j,u);var p=h.linearSolution(s,r,l,i,v,n,k,j,t);return new h.Transformation(q[0],q[1],q[2],p[0],p[1],p[2])};h.linearSolution=function(k,t,n,j,s,m,i,r,l){k=parseFloat(k);t=parseFloat(t);n=parseFloat(n);j=parseFloat(j);s=parseFloat(s);m=parseFloat(m);i=parseFloat(i);r=parseFloat(r);l=parseFloat(l);var q=(((m-l)*(t-s))-((n-m)*(s-r)))/(((j-i)*(t-s))-((k-j)*(s-r)));var p=(((m-l)*(k-j))-((n-m)*(j-i)))/(((s-r)*(k-j))-((t-s)*(j-i)));var o=n-(k*q)-(t*p);return[q,p,o]};h.Projection=function(j,i){if(!i){i=new h.Transformation(1,0,0,0,1,0)}this.zoom=j;this.transformation=i};h.Projection.prototype={zoom:0,transformation:null,rawProject:function(i){throw"Abstract method not implemented by subclass."},rawUnproject:function(i){throw"Abstract method not implemented by subclass."},project:function(i){i=this.rawProject(i);if(this.transformation){i=this.transformation.transform(i)}return i},unproject:function(i){if(this.transformation){i=this.transformation.untransform(i)}i=this.rawUnproject(i);return i},locationCoordinate:function(j){var i=new h.Point(Math.PI*j.lon/180,Math.PI*j.lat/180);i=this.project(i);return new h.Coordinate(i.y,i.x,this.zoom)},coordinateLocation:function(j){j=j.zoomTo(this.zoom);var i=new h.Point(j.column,j.row);i=this.unproject(i);return new h.Location(180*i.y/Math.PI,180*i.x/Math.PI)}};h.LinearProjection=function(j,i){h.Projection.call(this,j,i)};h.LinearProjection.prototype={rawProject:function(i){return new h.Point(i.x,i.y)},rawUnproject:function(i){return new h.Point(i.x,i.y)}};h.extend(h.LinearProjection,h.Projection);h.MercatorProjection=function(j,i){h.Projection.call(this,j,i)};h.MercatorProjection.prototype={rawProject:function(i){return new h.Point(i.x,Math.log(Math.tan(0.25*Math.PI+0.5*i.y)))},rawUnproject:function(i){return new h.Point(i.x,2*Math.atan(Math.pow(Math.E,i.y))-0.5*Math.PI)}};h.extend(h.MercatorProjection,h.Projection);h.MapProvider=function(i){if(i){this.getTileUrl=i}};h.MapProvider.prototype={projection:new h.MercatorProjection(0,h.deriveTransformation(-Math.PI,Math.PI,0,0,Math.PI,Math.PI,1,0,-Math.PI,-Math.PI,0,1)),tileWidth:256,tileHeight:256,topLeftOuterLimit:new h.Coordinate(0,0,0),bottomRightInnerLimit:new h.Coordinate(1,1,0).zoomTo(18),getTileUrl:function(i){throw"Abstract method not implemented by subclass."},locationCoordinate:function(i){return this.projection.locationCoordinate(i)},coordinateLocation:function(i){return this.projection.coordinateLocation(i)},outerLimits:function(){return[this.topLeftOuterLimit.copy(),this.bottomRightInnerLimit.copy()]},setZoomRange:function(j,i){this.topLeftOuterLimit=this.topLeftOuterLimit.zoomTo(j);this.bottomRightInnerLimit=this.bottomRightInnerLimit.zoomTo(i)},sourceCoordinate:function(n){var i=this.topLeftOuterLimit.zoomTo(n.zoom);var k=this.bottomRightInnerLimit.zoomTo(n.zoom);var j=k.row-i.row;if(n.row<0|n.row>=j){return null}var m=k.column-i.column;var l=n.column%m;while(l<0){l+=m}return new h.Coordinate(n.row,l,n.zoom)}};h.TemplatedMapProvider=function(j,i){h.MapProvider.call(this,function(m){m=this.sourceCoordinate(m);if(!m){return null}var k=j;if(i&&i.length&&k.indexOf("{S}")>=0){var l=parseInt(m.zoom+m.row+m.column,10)%i.length;k=k.replace("{S}",i[l])}return k.replace("{Z}",m.zoom.toFixed(0)).replace("{X}",m.column.toFixed(0)).replace("{Y}",m.row.toFixed(0))})};h.extend(h.TemplatedMapProvider,h.MapProvider);h.MouseHandler=function(i){if(i!==undefined){this.init(i)}};h.MouseHandler.prototype={init:function(i){this.map=i;h.addEvent(i.parent,"dblclick",this.getDoubleClick());h.addEvent(i.parent,"mousedown",this.getMouseDown());h.addEvent(i.parent,"mousewheel",this.getMouseWheel())},mouseDownHandler:null,getMouseDown:function(){if(!this.mouseDownHandler){var i=this;this.mouseDownHandler=function(j){h.addEvent(document,"mouseup",i.getMouseUp());h.addEvent(document,"mousemove",i.getMouseMove());i.prevMouse=new h.Point(j.clientX,j.clientY);i.map.parent.style.cursor="move";return h.cancelEvent(j)}}return this.mouseDownHandler},mouseMoveHandler:null,getMouseMove:function(){if(!this.mouseMoveHandler){var i=this;this.mouseMoveHandler=function(j){if(i.prevMouse){i.map.panBy(j.clientX-i.prevMouse.x,j.clientY-i.prevMouse.y);i.prevMouse.x=j.clientX;i.prevMouse.y=j.clientY}return h.cancelEvent(j)}}return this.mouseMoveHandler},mouseUpHandler:null,getMouseUp:function(){if(!this.mouseUpHandler){var i=this;this.mouseUpHandler=function(j){h.removeEvent(document,"mouseup",i.getMouseUp());h.removeEvent(document,"mousemove",i.getMouseMove());i.prevMouse=null;i.map.parent.style.cursor="";return h.cancelEvent(j)}}return this.mouseUpHandler},mouseWheelHandler:null,getMouseWheel:function(){if(!this.mouseWheelHandler){var j=this;var i=new Date().getTime();this.mouseWheelHandler=function(m){var n=0;if(m.wheelDelta){n=m.wheelDelta}else{if(m.detail){n=-m.detail}}var l=new Date().getTime()-i;if(Math.abs(n)>0&&(l>200)){var k=j.getMousePoint(m);j.map.zoomByAbout(n>0?1:-1,k);i=new Date().getTime()}return h.cancelEvent(m)}}return this.mouseWheelHandler},doubleClickHandler:null,getDoubleClick:function(){if(!this.doubleClickHandler){var i=this;this.doubleClickHandler=function(k){var j=i.getMousePoint(k);i.map.zoomByAbout(k.shiftKey?-1:1,j);return h.cancelEvent(k)}}return this.doubleClickHandler},getMousePoint:function(k){var i=new h.Point(k.clientX,k.clientY);i.x+=document.body.scrollLeft+document.documentElement.scrollLeft;i.y+=document.body.scrollTop+document.documentElement.scrollTop;for(var j=this.map.parent;j;j=j.offsetParent){i.x-=j.offsetLeft;i.y-=j.offsetTop}return i}};function g(j,i){return Math.sqrt(Math.pow(j.screenX-i.screenX,2)+Math.pow(j.screenY-i.screenY,2))}function e(j,i){this.screenX=j.screenX;this.screenY=j.screenY;this.touch=j;this.time=i;this.start=this;this.count=0;this.travel=0;this.last=null}function f(k,i,j){moved=g(k,i);this.screenX=k.screenX;this.screenY=k.screenY;this.touch=k;this.time=j;this.start=i.start;this.count=i.count+1;this.travel=i.travel+moved;this.last=i}function a(i,j){if(i&&i.touch){return j.identifier==i.touch.identifier}}function d(l){var j=new Date().getTime();for(var k=0;k<l.length;k+=1){var n=l[k].touch;var m=new e(n,j);l[k]=m}}function c(l){var k=l.start;var i=l.screenX-k.screenX;var j=l.screenY-k.screenY;return[1,0,0,1,i,j]}function b(o,m){var i=o.start,p=m.start;var u=g(o,m),n=g(i,p);var v=u/n;var t=(o.screenX+m.screenX)/2,q=(o.screenY+m.screenY)/2;var j=(i.screenX+p.screenX)/2,r=(i.screenY+p.screenY)/2;var l=v*-j+t,k=v*-r+q;return[v,0,0,v,l,k]}h.TouchHandler=function(){};h.TouchHandler.prototype={maxTapTime:150,maxTapDistance:10,maxDoubleTapDelay:350,events:[],taps:[],init:function(i){this.map=i;h.addEvent(i.parent,"touchstart",this.getTouchStartMachine());h.addEvent(i.parent,"touchmove",this.getTouchMoveMachine());h.addEvent(i.parent,"touchend",this.getTouchEndMachine())},getTouchStartMachineHandler:null,getTouchStartMachine:function(){if(!this.getTouchStartMachineHandler){var j=this;var i=this.events;this.getTouchStartMachineHandler=function(l){d(i);for(var k=0;k<l.changedTouches.length;k+=1){var n=l.changedTouches[k];var m=new e(n,new Date().getTime());i.push(m)}return h.cancelEvent(l)}}return this.getTouchStartMachineHandler},getTouchStartMachineHandler:null,getTouchMoveMachine:function(){if(!this.getTouchMoveMachineHandler){var j=this;var i=this.events;this.getTouchMoveMachineHandler=function(n){var l=new Date().getTime();for(var m=0,o=n.changedTouches[m];m<n.changedTouches.length;m+=1){for(var k=0;k<i.length;k+=1){if(a(i[k],o)){i[k]=new f(o,i[k],l)}}}if(i.length==1){j.onPanning(i[0])}else{if(i.length==2){j.onPinching(i[0],i[1])}}return h.cancelEvent(n)}}return this.getTouchMoveMachineHandler},getTouchEndMachineHandler:null,getTouchEndMachine:function(){if(!this.getTouchEndMachineHandler){var j=this;var i=this.events;this.getTouchEndMachineHandler=function(p){var l=new Date().getTime();if(i.length==1){j.onPanned(i[0])}else{if(i.length==2){j.onPinched(i[0],i[1])}}for(var m=0;m<p.changedTouches.length;m+=1){var q=p.changedTouches[m];for(var k=0;k<i.length;k+=1){if(a(i[k],q)){var n=new f(q,i[k],l);i.splice(k,1);k-=1;var o=l-n.start.time;if(n.travel>j.maxTapDistance){}else{if(o>j.maxTapTime){j.onHold({x:q.screenX,y:q.screenY,end:l,duration:o})}else{j.onTap({x:q.screenX,y:q.screenY,time:l})}}}}}d(i);if(p.touches.length==0&&i.length>=1){i.splice(0,i.length)}return h.cancelEvent(p)}}return this.getTouchEndMachineHandler},onHold:function(i){},onTap:function(i){if(this.taps.length&&(i.time-this.taps[0].time)<this.maxDoubleTapDelay){this.onDoubleTap(i);return}this.taps=[i]},onDoubleTap:function(i){var k=Math.floor(this.map.getZoom()+2);k=k-this.map.getZoom();var j=new h.Point(i.x,i.y);this.map.zoomByAbout(k,j)},onPanning:function(j){var i=c(j);i=["1","0","0","0","0","1","0","0","0","0","1","0",i[4].toFixed(0),i[5].toFixed(0),"0","1"];i="matrix3d("+i.join(", ")+")";this.map.parent.style.webkitTransformOrigin="0px 0px";this.map.parent.style.webkitTransform=i},onPanned:function(j){var i=c(j);this.map.panBy(i[4],i[5]);this.map.parent.style.webkitTransform=""},onPinching:function(k,j){var i=b(k,j);i=[i[0].toFixed(3),"0","0","0","0",i[3].toFixed(3),"0","0","0","0","1","0",i[4].toFixed(0),i[5].toFixed(0),"0","1"];i="matrix3d("+i.join(", ")+")";this.map.parent.style.webkitTransformOrigin="0px 0px";this.map.parent.style.webkitTransform=i},onPinched:function(k,j){var i=b(k,j);var n=Math.log(i[0])/Math.log(2);var l=new h.Point(0,0);this.map.zoomByAbout(n,l).panBy(i[4],i[5]);this.map.parent.style.webkitTransform=""}};h.CallbackManager=function(j,l){this.owner=j;this.callbacks={};for(var k=0;k<l.length;k++){this.callbacks[l[k]]=[]}};h.CallbackManager.prototype={owner:null,callbacks:null,addCallback:function(i,j){if(typeof(j)=="function"&&this.callbacks[i]){this.callbacks[i].push(j)}},removeCallback:function(m,n){if(typeof(n)=="function"&&this.callbacks[m]){var k=this.callbacks[m],j=k.length;for(var l=0;l<j;l++){if(k[l]===n){k.splice(l,1);break}}}},dispatchCallback:function(l,k){if(this.callbacks[l]){for(var j=0;j<this.callbacks[l].length;j+=1){try{this.callbacks[l][j](this.owner,k)}catch(m){}}}}};h.RequestManager=function(i){this.loadingBay=document.createDocumentFragment();this.requestsById={};this.openRequestCount=0;this.maxOpenRequests=4;this.requestQueue=[];this.callbackManager=new h.CallbackManager(this,["requestcomplete"])};h.RequestManager.prototype={loadingBay:null,requestsById:null,requestQueue:null,openRequestCount:null,maxOpenRequests:null,callbackManager:null,addCallback:function(i,j){this.callbackManager.addCallback(i,j)},removeCallback:function(i,j){this.callbackManager.removeCallback(i,j)},dispatchCallback:function(j,i){this.callbackManager.dispatchCallback(j,i)},clear:function(){this.clearExcept({})},clearExcept:function(p){for(var n=0;n<this.requestQueue.length;n++){var o=this.requestQueue[n];if(o&&!(o.key in p)){this.requestQueue[n]=null}}var k=this.loadingBay.childNodes;for(var m=k.length-1;m>=0;m--){var l=k[m];if(!(l.id in p)){this.loadingBay.removeChild(l);this.openRequestCount--;l.src=l.coord=l.onload=l.onerror=null}}for(var q in this.requestsById){if(this.requestsById.hasOwnProperty(q)){if(!(q in p)){var o=this.requestsById[q];delete this.requestsById[q];if(o!==null){o=o.key=o.coord=o.url=null}}}}},hasRequest:function(i){return(i in this.requestsById)},requestTile:function(j,l,i){if(!(j in this.requestsById)){var k={key:j,coord:l.copy(),url:i};this.requestsById[j]=k;if(i){this.requestQueue.push(k)}}},getProcessQueue:function(){if(!this._processQueue){var i=this;this._processQueue=function(){i.processQueue()}}return this._processQueue},processQueue:function(k){if(k&&this.requestQueue.length>8){this.requestQueue.sort(k)}while(this.openRequestCount<this.maxOpenRequests&&this.requestQueue.length>0){var j=this.requestQueue.pop();if(j){this.openRequestCount++;var i=document.createElement("img");i.id=j.key;i.style.position="absolute";i.coord=j.coord;this.loadingBay.appendChild(i);i.onload=i.onerror=this.getLoadComplete();i.src=j.url;j=j.key=j.coord=j.url=null}}},_loadComplete:null,getLoadComplete:function(){if(!this._loadComplete){var i=this;this._loadComplete=function(k){k=k||window.event;var j=k.srcElement||k.target;j.onload=j.onerror=null;i.loadingBay.removeChild(j);i.openRequestCount--;delete i.requestsById[j.id];if(j.complete||(j.readyState&&j.readyState=="complete")){i.dispatchCallback("requestcomplete",j)}else{j.src=null}setTimeout(i.getProcessQueue(),0)}}return this._loadComplete}};h.Map=function(q,p,j,k){if(typeof q=="string"){q=document.getElementById(q)}this.parent=q;this.parent.style.padding="0";this.parent.style.overflow="hidden";var o=h.getStyle(this.parent,"position");if(o!="relative"&&o!="absolute"){this.parent.style.position="relative"}if(!j){var r=this.parent.offsetWidth;var n=this.parent.offsetHeight;if(!r){r=640;this.parent.style.width=r+"px"}if(!n){n=480;this.parent.style.height=n+"px"}j=new h.Point(r,n);var l=this;h.addEvent(window,"resize",function(i){l.dimensions=new h.Point(l.parent.offsetWidth,l.parent.offsetHeight);l.draw();l.dispatchCallback("resized",[l.dimensions])})}else{this.parent.style.width=Math.round(j.x)+"px";this.parent.style.height=Math.round(j.y)+"px"}this.dimensions=j;this.requestManager=new h.RequestManager(this.parent);this.requestManager.addCallback("requestcomplete",this.getTileComplete());this.layers={};this.layerParent=document.createElement("div");this.layerParent.id=this.parent.id+"-layers";this.layerParent.style.cssText="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; margin: 0; padding: 0; z-index: 0";this.parent.appendChild(this.layerParent);this.coordinate=new h.Coordinate(0.5,0.5,0);this.setProvider(p);this.enablePyramidLoading=false;this.callbackManager=new h.CallbackManager(this,["zoomed","panned","centered","extentset","resized","drawn"]);if(k===undefined){this.eventHandlers=[];this.eventHandlers.push(new h.MouseHandler(this))}else{this.eventHandlers=k;if(k instanceof Array){for(var m=0;m<k.length;m++){k[m].init(this)}}}};h.Map.prototype={parent:null,provider:null,dimensions:null,coordinate:null,tiles:null,layers:null,layerParent:null,requestManager:null,tileCacheSize:null,maxTileCacheSize:null,recentTiles:null,recentTilesById:null,callbackManager:null,eventHandlers:null,toString:function(){return"Map(#"+this.parent.id+")"},addCallback:function(i,j){this.callbackManager.addCallback(i,j)},removeCallback:function(i,j){this.callbackManager.removeCallback(i,j)},dispatchCallback:function(j,i){this.callbackManager.dispatchCallback(j,i)},zoomBy:function(i){this.coordinate=this.coordinate.zoomBy(i);this.draw();this.dispatchCallback("zoomed",i);return this},zoomIn:function(){return this.zoomBy(1)},zoomOut:function(){return this.zoomBy(-1)},setZoom:function(i){return this.zoomBy(i-this.coordinate.zoom)},zoomByAbout:function(j,i){var l=this.pointLocation(i);this.zoomBy(j);var k=this.locationPoint(l);return this.panBy(i.x-k.x,i.y-k.y)},panBy:function(j,i){this.coordinate.column-=j/this.provider.tileWidth;this.coordinate.row-=i/this.provider.tileHeight;this.draw();this.dispatchCallback("panned",[j,i]);return this},panLeft:function(){return this.panBy(100,0)},panRight:function(){return this.panBy(-100,0)},panDown:function(){return this.panBy(0,-100)},panUp:function(){return this.panBy(0,100)},setCenter:function(i){return this.setCenterZoom(i,this.coordinate.zoom)},setCenterZoom:function(i,j){this.coordinate=this.provider.locationCoordinate(i).zoomTo(parseFloat(j)||0);this.draw();this.dispatchCallback("centered",[i,j]);return this},setExtent:function(r){var p,o;for(var n=0;n<r.length;n++){var x=this.provider.locationCoordinate(r[n]);if(p){p.row=Math.min(p.row,x.row);p.column=Math.min(p.column,x.column);p.zoom=Math.min(p.zoom,x.zoom);o.row=Math.max(o.row,x.row);o.column=Math.max(o.column,x.column);o.zoom=Math.max(o.zoom,x.zoom)}else{p=x.copy();o=x.copy()}}var k=this.dimensions.x+1;var y=this.dimensions.y+1;var j=(o.column-p.column)/(k/this.provider.tileWidth);var s=Math.log(j)/Math.log(2);var t=p.zoom-Math.ceil(s);var u=(o.row-p.row)/(y/this.provider.tileHeight);var z=Math.log(u)/Math.log(2);var w=p.zoom-Math.ceil(z);var l=Math.min(t,w);l=Math.min(l,this.provider.outerLimits()[1].zoom);l=Math.max(l,this.provider.outerLimits()[0].zoom);var m=(p.row+o.row)/2;var q=(p.column+o.column)/2;var v=p.zoom;this.coordinate=new h.Coordinate(m,q,v).zoomTo(l);this.draw();this.dispatchCallback("extentset",r);return this},setSize:function(j,i){if(j.hasOwnProperty("x")&&j.hasOwnProperty("y")){this.dimensions=j}else{if(i!==undefined&&!isNaN(i)){this.dimensions=new h.Point(j,i)}}this.parent.style.width=Math.round(this.dimensions.x)+"px";this.parent.style.height=Math.round(this.dimensions.y)+"px";this.draw();this.dispatchCallback("resized",[this.dimensions]);return this},coordinatePoint:function(j){if(j.zoom!=this.coordinate.zoom){j=j.zoomTo(this.coordinate.zoom)}var i=new h.Point(this.dimensions.x/2,this.dimensions.y/2);i.x+=this.provider.tileWidth*(j.column-this.coordinate.column);i.y+=this.provider.tileHeight*(j.row-this.coordinate.row);return i},pointCoordinate:function(i){var j=this.coordinate.copy();j.column+=(i.x-this.dimensions.x/2)/this.provider.tileWidth;j.row+=(i.y-this.dimensions.y/2)/this.provider.tileHeight;return j},locationPoint:function(i){return this.coordinatePoint(this.provider.locationCoordinate(i))},pointLocation:function(i){return this.provider.coordinateLocation(this.pointCoordinate(i))},getExtent:function(){var i=[];i.push(this.pointLocation(new h.Point(0,0)));i.push(this.pointLocation(this.dimensions));return i},getCenter:function(){return this.provider.coordinateLocation(this.coordinate)},getZoom:function(){return this.coordinate.zoom},setProvider:function(k){var l=false;if(this.provider===null){l=true}if(!l){this.requestManager.clear();for(var i in this.layers){if(this.layers.hasOwnProperty(i)){var j=this.layers[i];while(j.firstChild){j.removeChild(j.firstChild)}}}}this.tiles={};this.tileCacheSize=0;this.maxTileCacheSize=64;this.recentTiles=[];this.recentTilesById={};this.provider=k;if(!l){this.draw()}return this},enforceLimits:function(l){l=l.copy();var j=this.provider.outerLimits();if(j){var k=j[0].zoom;var i=j[1].zoom;if(l.zoom<k){l=l.zoomTo(k)}else{if(l.zoom>i){l=l.zoomTo(i)}}}return l},draw:function(){this.coordinate=this.enforceLimits(this.coordinate);var v=Math.round(this.coordinate.zoom);var B=this.pointCoordinate(new h.Point(0,0)).zoomTo(v).container();var z=this.pointCoordinate(this.dimensions).zoomTo(v).container().right().down();var r=0;if(r){B=B.left(r).up(r);z=z.right(r).down(r)}var N={};var s=this.createOrGetLayer(B.zoom);var n=B.copy();for(n.column=B.column;n.column<=z.column;n.column+=1){for(n.row=B.row;n.row<=z.row;n.row+=1){var t=n.toKey();N[t]=true;if(t in this.tiles){var Q=this.tiles[t];if(Q.parentNode!=s){s.appendChild(Q)}}else{if(!this.requestManager.hasRequest(t)){var u=this.provider.getTileUrl(n);this.requestManager.requestTile(t,n,u)}var x=false;var M=n.zoom;for(var y=1;y<=M;y++){var A=n.zoomBy(-y).container();var F=A.toKey();if(this.enablePyramidLoading){N[F]=true;var G=this.createOrGetLayer(A.zoom);if(F in this.tiles){var C=this.tiles[F];if(C.parentNode!=G){G.appendChild(C)}}else{if(!this.requestManager.hasRequest(F)){var u=this.provider.getTileUrl(A);this.requestManager.requestTile(F,A,u)}}}else{if(F in this.tiles){N[F]=true;x=true;break}}}if(!x&&!this.enablePyramidLoading){var q=n.zoomBy(1);N[q.toKey()]=true;q.column+=1;N[q.toKey()]=true;q.row+=1;N[q.toKey()]=true;q.column-=1;N[q.toKey()]=true}}}}for(var R in this.layers){if(this.layers.hasOwnProperty(R)){var m=parseInt(R,10);if(m>=B.zoom-5&&m<B.zoom+2){continue}var P=this.layers[R];P.style.display="none";var L=P.getElementsByTagName("img");for(var D=L.length-1;D>=0;D--){P.removeChild(L[D])}}}var o=new Date().getTime();var H=B.zoom-5;var p=B.zoom+2;for(var E=H;E<p;E++){var P=this.layers[E];if(!P){continue}var O=1;var l=this.coordinate.copy();if(P.childNodes.length>0){P.style.display="block";O=Math.pow(2,this.coordinate.zoom-E);l=l.zoomTo(E)}else{P.style.display="none"}var k=this.provider.tileWidth*O;var w=this.provider.tileHeight*O;var J=new h.Point(this.dimensions.x/2,this.dimensions.y/2);var L=P.getElementsByTagName("img");for(var D=L.length-1;D>=0;D--){var Q=L[D];if(!N[Q.id]){P.removeChild(Q)}else{var K=J.x+(Q.coord.column-l.column)*k;var I=J.y+(Q.coord.row-l.row)*w;Q.style.left=Math.round(K)+"px";Q.style.top=Math.round(I)+"px";Q.style.width=Math.ceil(k)+"px";Q.style.height=Math.ceil(w)+"px";this.recentTilesById[Q.id].lastTouchedTime=o}}}this.requestManager.clearExcept(N);this.requestManager.processQueue(this.getCenterDistanceCompare());this.checkCache();this.dispatchCallback("drawn")},_tileComplete:null,getTileComplete:function(){if(!this._tileComplete){var i=this;this._tileComplete=function(n,o){i.tiles[o.id]=o;i.tileCacheSize++;var l={id:o.id,lastTouchedTime:new Date().getTime()};i.recentTilesById[o.id]=l;i.recentTiles.push(l);var m=i.coordinate.zoomTo(o.coord.zoom);var q=Math.pow(2,i.coordinate.zoom-o.coord.zoom);var k=((i.dimensions.x/2)+(o.coord.column-m.column)*i.provider.tileWidth*q);var j=((i.dimensions.y/2)+(o.coord.row-m.row)*i.provider.tileHeight*q);o.style.left=Math.round(k)+"px";o.style.top=Math.round(j)+"px";o.style.width=Math.ceil(i.provider.tileWidth*q)+"px";o.style.height=Math.ceil(i.provider.tileHeight*q)+"px";var p=i.layers[o.coord.zoom];p.appendChild(o);o.className="map-tile-loaded";if(Math.round(i.coordinate.zoom)==o.coord.zoom){p.style.display="block"}i.requestRedraw()}}return this._tileComplete},_redrawTimer:undefined,requestRedraw:function(){if(!this._redrawTimer){this._redrawTimer=setTimeout(this.getRedraw(),1000)}},_redraw:null,getRedraw:function(){if(!this._redraw){var i=this;this._redraw=function(){i.draw();i._redrawTimer=0}}return this._redraw},createOrGetLayer:function(j){if(j in this.layers){return this.layers[j]}var i=document.createElement("div");i.id=this.parent.id+"-zoom-"+j;i.style.cssText=this.layerParent.style.cssText;i.style.zIndex=j;this.layerParent.appendChild(i);this.layers[j]=i;return i},checkCache:function(){var m=this.parent.getElementsByTagName("img").length;var k=Math.max(m,this.maxTileCacheSize);if(this.tileCacheSize>k){this.recentTiles.sort(function(o,n){return n.lastTouchedTime<o.lastTouchedTime?-1:n.lastTouchedTime>o.lastTouchedTime?1:0})}while(this.tileCacheSize>k){var j=this.recentTiles.pop();var i=new Date().getTime();delete this.recentTilesById[j.id];var l=this.tiles[j.id];if(l.parentNode){alert("Gah: trying to removing cached tile even though it's still in the DOM")}else{delete this.tiles[j.id];this.tileCacheSize--}}},getCenterDistanceCompare:function(){var i=this.coordinate.zoomTo(Math.round(this.coordinate.zoom));return function(l,k){if(l&&k){var n=l.coord;var m=k.coord;if(n.zoom==m.zoom){var j=Math.abs(i.row-n.row-0.5)+Math.abs(i.column-n.column-0.5);var o=Math.abs(i.row-m.row-0.5)+Math.abs(i.column-m.column-0.5);return j<o?1:j>o?-1:0}else{return n.zoom<m.zoom?1:n.zoom>m.zoom?-1:0}}return l?1:k?-1:0}}};if(typeof module!=="undefined"&&module.exports){module.exports={Point:h.Point,Projection:h.Projection,MercatorProjection:h.MercatorProjection,LinearProjection:h.LinearProjection,Transformation:h.Transformation,Location:h.Location,MapProvider:h.MapProvider,TemplatedMapProvider:h.TemplatedMapProvider,Coordinate:h.Coordinate}}})(com.modestmaps);